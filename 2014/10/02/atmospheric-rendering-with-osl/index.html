<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">

  
  <title>Atmospheric Rendering with OSL</title>
  <link rel="canonical" href="http://bensimonds.com/2014/10/02/atmospheric-rendering-with-osl/">
  
  <meta name="description" content="My latest experiment into OSL shading is focused on implementing a sky shading model similar to cycles’ existing sky textures. Whilst Blender’s existi">
  
  
  <meta name="author" content="Ben Simonds">
  
  <meta property="og:image" content="http://bensimonds.comundefined">
  
  <meta property="og:site_name" content="Ben Simonds&#39; Personal Blog" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Atmospheric Rendering with OSL" />
  
  <meta property="og:description" content="My latest experiment into OSL shading is focused on implementing a sky shading model similar to cycles’ existing sky textures. Whilst Blender’s existi">
  
  <meta property="og:url" content="http://bensimonds.com/2014/10/02/atmospheric-rendering-with-osl/" />

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Atmospheric Rendering with OSL">
  
  <meta name="twitter:description" content="My latest experiment into OSL shading is focused on implementing a sky shading model similar to cycles’ existing sky textures. Whilst Blender’s existi">
  
  
  <meta name="twitter:image" content="http://bensimonds.comundefined">
  
  <meta name="twitter:url" content="http://bensimonds.com/2014/10/02/atmospheric-rendering-with-osl/" />

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  
<link rel="stylesheet" href="/css/reset.css">

  
<link rel="stylesheet" href="/css/base.css">

  
  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="icon" type="image/png" href="/images/favicon.png">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div class="container">

    <header>
  <!-- Title -->
  <div style="display:flex; flex-wrap: wrap; flex-direction:row; width: 100%; align-items: baseline; margin-bottom: -20px;">
    <h1 style="margin-bottom: 0px;">
      <a tyle="text-decoration: none;">
        BenSimonds.com
      </a>
    </h1>
    <a style=" margin-left: auto; font-size: 0.8rem;" id="siteBannerLink" href="/2011/10/13/abandoned-power-station/">Abandoned Power Station</a>
  </div>
  <!-- Site Banner Image -->

  <a href="/">
    <img id="siteBanner" class="banner" src="/images/banner-warehouse-1.png" />
  </a>

  <script>
    var banners = [
      { imgUrl: "/images/banner-fractal.png", title: "Fun with Instancing In Cycles", url: "/2012/07/04/fun-with-instancing-in-cycles/" },
      { imgUrl: "/images/banner-temple.png", title: "Blender Masterclass", url: "/2013/01/04/blender-master-class-a-hands-on-guide-to-modeling-sculpting-materials-and-rendering/" },
      { imgUrl: "/images/banner-spiderbot.png", title: "Blender Masterclass", url: "/2013/01/04/blender-master-class-a-hands-on-guide-to-modeling-sculpting-materials-and-rendering/" },
      { imgUrl: "/images/banner-pirate.jpg", title: "Blending Life 2010", url: "/2010/02/24/blending-life-2010" },
      { imgUrl: "/images/banner-warehouse-3.png", title: "Abandoned Power Station", url: "/2011/10/13/abandoned-power-station/" },
      { imgUrl: "/images/banner-warehouse-2.png", title: "Abandoned Power Station", url: "/2011/10/13/abandoned-power-station/" },
      { imgUrl: "/images/banner-warehouse-1.png", title: "Abandoned Power Station", url: "/2011/10/13/abandoned-power-station/" },
      { imgUrl: "/images/banner-circle-packing.png", title: "Mitchell's Best Candidate Algorithm", url: "/2023/02/22/circle-packing/" },
      { imgUrl: "/images/banner-perlin-snakes.png", title: "Perlin Snakes", url: "/2023/02/19/perlin-snakes/" },
      { imgUrl: "/images/banner-kumiko.svg", title: "Kumiko Grids", url: "/2023/02/28/kumiko-grids/" },
    ];
    var randomNum = Math.floor(Math.random() * banners.length);
    document.getElementById("siteBanner").src = banners[randomNum].imgUrl;
    document.getElementById("siteBannerLink").href = banners[randomNum].url;
    document.getElementById("siteBannerLink").textContent = banners[randomNum].title;

  </script>

  <!-- Navbar -->
  <nav>
    <ul>
      <li><a href="/">Home</a></li>
      
        <li><a href="/blender">Blender</a></li>
        
    </ul>
  </nav>
  <hr />
</header>


    


    <h2>Atmospheric Rendering with OSL</h2>
  
  
  <p><a href="/images/old/nishitaskyrender10.jpg"><img src="/images/old/nishitaskyrender10.jpg?w=470" alt="NishitaSkyRender10 &gt;&lt;"></a></p>
<p>My latest experiment into OSL shading is focused on implementing a sky shading model similar to cycles’ existing sky textures. Whilst Blender’s existing options work pretty well, they only allow you to render the sky as it appears at sea level. I wanted a shader that could simulate the sky at any altitude, even from outside the Earth’s atmosphere. After some research I was able to track down an article on <a target="_blank" rel="noopener" href="http://www.scratchapixel.com/lessons/3d-advanced-lessons/simulating-the-colors-of-the-sky/atmospheric-scattering/">rendering atmospheric scattering</a> at ScratchAPixel.com, which does a great job of explaining a model for rendering Earths atmosphere based on a 1993 technical paper by Tomoyuki Nishita. </p>
<p>I wont bother explaining the maths in too much detail here, as frankly I don’t 100% understand it anyway, and the ScratchAPixel article does a far better job than I could. But I wanted to share the results and my osl shader code for anyone who might be interested. The shader works by sampling the path out from the camera, through the atmosphere out into space (or until we hit the earth) and adding together all of the sunlight scattered by the atmosphere (only single scattering is taken into account). Two kinds of scattering of light by the atmosphere are considered. Rayleigh scattering is the scattering of light by small molecules; those smaller than the wavelengths of visible light. Rayleigh scattering affects short wavelengths of light more than long ones and so blue light is scattered more strongly . Mie scattering is the scattering of light by larger particles called aerosols, and is largely independent of wavelength. Rayleigh scattering is what gives the sky its blue colour and sunsets their red colour. Skies are normally blue because you’re seeing predominantly the blue light scattered by Rayleigh scattering. A sunset looks red because you’re looking towards the sun, and the sunlight at the horizon has to travel further through the atmosphere to reach you, so the blue light has already been scattered out by the time the remaining light reaches you. As you move higher in the Earth’s atmosphere it becomes less dense, and so Nishita’s model accounts for this by applying an exponential falloff to the amount of scattering as we progress higher in the atmosphere. This means as we go higher, the sky begins to look darker as we see less scattered light, and more of the darkness of space beyond. Anyway, here’s my OSL shader code and some renders. <a target="_blank" rel="noopener" href="https://github.com/BenSimonds/NishitaSky">Nishita Atmosphere Shader on GitHub</a> Some different altitudes (at midday):</p>
<p><a href="/images/old/altitudes.jpg"><img src="/images/old/altitudes.jpg?w=364" alt="Altitudes &gt;&lt;"></a></p>
<p>A test with Suzanne:</p>
<p><a href="/images/old/nishitaskyrender9.jpg"><img src="/images/old/nishitaskyrender9.jpg?w=470" alt="NishitaSkyRender9 &gt;&lt;"></a></p>
<p>Some desktop wallpaper res shots.</p>
<p><a href="/images/old/nishitaskyrender5.jpg"><img src="/images/old/nishitaskyrender5.jpg?w=470" alt="NishitaSkyRender5 &gt;&lt;"></a></p>
<p><a href="/images/old/nishitaskyrender7.jpg"><img src="/images/old/nishitaskyrender7.jpg?w=470" alt="NishitaSkyRender7 &gt;&lt;"></a></p>
<p><a href="/images/old/nishitaskyrender8.jpg"><img src="/images/old/nishitaskyrender8.jpg?w=470" alt="NishitaSkyRender8 &gt;&lt;"></a></p>
<h3 id="Rendering-Planets"><a href="#Rendering-Planets" class="headerlink" title="Rendering Planets"></a>Rendering Planets</h3><p>Following on from getting the sky shader working, I wondered if it would be any good for rendering planets - it could already render an atmosphere of a planet, and it part of the code for the shader already found where on the planet the camera rays hit. From this I could also generate coordinates for rendering a texture on the planet, and with a bit of extra code and some nodes in blender I had a set up that I could render Earth (and other planets) with. It’s still very experimental, and it doesn’t do anything advanced like rendering clouds, but it’s been pretty fun to mess around with. Here’s some images. You can find the code for the OSL portion of the shader on github. They’re pretty rough, but the neat thing about them I think is that there’s <strong>no geometry</strong> in the scene! Just a shader on the background. Some Earth renders (looks a little weird without clouds):</p>
<p><a href="/images/old/planettest1.jpg"><img src="/images/old/planettest1.jpg?w=470" alt="PlanetTest1 &gt;&lt;"></a></p>
<p><a href="/images/old/planettest5.jpg"><img src="/images/old/planettest5.jpg?w=470" alt="PlanetTest5 &gt;&lt;"></a></p>
<p>Mars with some water:</p>
<p><a href="/images/old/planettest7.jpg"><img src="/images/old/planettest7.jpg?w=470" alt="PlanetTest7 &gt;&lt;"></a></p>
<p>And some procedural&#x2F;grunge texture based planets!</p>
<p><a href="/images/old/planettest2.jpg"><img src="/images/old/planettest2.jpg?w=470" alt="PlanetTest2 &gt;&lt;"></a></p>
<p><a href="/images/old/planettest3.jpg"><img src="/images/old/planettest3.jpg?w=470" alt="PlanetTest3 &gt;&lt;"></a></p>
<p><a href="/images/old/planettest6.jpg"><img src="/images/old/planettest6.jpg?w=470" alt="PlanetTest6 &gt;&lt;"></a></p>
<p><a href="/images/old/planettest8.jpg"><img src="/images/old/planettest8.jpg?w=470" alt="PlanetTest8 &gt;&lt;"></a></p>
<h1 id="Comments"><a href="#Comments" class="headerlink" title="Comments"></a>Comments</h1><p>Joe (Aug 07, 2018)</p>
<blockquote>
<p>How do you get the planet to appear anywhere else on the screen except the very bottom? Its a tad inconvenient.</p>
</blockquote>
<p>KazanNInja (Nov 15, 2015)</p>
<blockquote>
<p>Can you post a node setup with the earth?</p>
<p>Thanks</p>
</blockquote>
<p>Deane Saunders-Stowe (@DSaundersStowe) (May 11, 2016)</p>
<blockquote>
<p>Stunning output, and exactly what I’ve been hunting months for!</p>
</blockquote>
<p>Alex (Aug 19, 2015)</p>
<blockquote>
<p>Hi Ben,</p>
<p>When I put external file to script node and click reload i get:<br>error: No shader function defined in console.<br>I use Blender 2.75a. What can be wrong?</p>
<p>Best regards.<br>Alex</p>
</blockquote>
<p>Alex (Aug 19, 2015)</p>
<blockquote>
<p>Ok!. It seems to work great when text pasted.<br>Is it possible to somehow “convert” it to bitmap to speed it up with static shots? It’s now really slow compared to internal blender sky.</p>
</blockquote>
<p>Ben Simonds (Aug 19, 2015)</p>
<blockquote>
<p>You could put an equirectangular camera in the scene and render out a HDR. Then use that as your environment map.</p>
</blockquote>
<p>Ben Simonds (Jul 09, 2015)</p>
<blockquote>
<p>Like I say, the scene has <em>zero</em> geometry. It’s all a world shader including the planet.</p>
</blockquote>
<p>vibersoul (Dec 22, 2014)</p>
<blockquote>
<p>How to connect the inputs? this is what i’m trying to do to get earth atmosphere:<br><a target="_blank" rel="noopener" href="http://digilander.libero.it/cauldron/screen.jpg">http://digilander.libero.it/cauldron/screen.jpg</a></p>
</blockquote>
<p>Ben Simonds (Dec 22, 2014)</p>
<blockquote>
<p>You font need a mesh for this shader - it works when plugged into the background node. </p>
</blockquote>
<p>vibersoul (Dec 22, 2014)</p>
<blockquote>
<p>yes i’ve tried already..but the effect to me appears behind the planet..not the same as your screenshots! should i add another layer? and also how to make it coincide with planet position and sun direction? thank you!</p>
</blockquote>
<p>Ben Simonds (Dec 22, 2014)</p>
<blockquote>
<p>So for my scene i also rendered the planet’s surface as a background shader. No geometry in the scene. I can send you an example file later if you’re interested.</p>
</blockquote>
<p>Ryan (May 06, 2015)</p>
<blockquote>
<p>I’m wondering if there are any tips for making the horizon look convincing with this. Should I do a large sphere for the ground or just hide the horizon with hills?</p>
</blockquote>
<p>Andreas (Nov 21, 2014)</p>
<blockquote>
<p>Hi Ben, </p>
<p>i really like this shader! Is it anyway possible to tell us how we can use this to render a real planet (Texture etc) or better if it’s possible to combine the shader with this one: <a target="_blank" rel="noopener" href="https://github.com/sambler/osl-shaders/tree/master/combine-multiple/FBImagePlanet">https://github.com/sambler/osl-shaders/tree/master/combine-multiple/FBImagePlanet</a> ?</p>
<p>best regards<br>Andreas</p>
</blockquote>
<p>Omi (Aug 26, 2015)</p>
<blockquote>
<p>Hey Alex, would you mind describing how you got it to work? I tried connecting Sky to World Output: Surface but I don’t see anything.</p>
<p>Thanks,<br>Omi</p>
</blockquote>
<p>Omi (Aug 26, 2015)</p>
<blockquote>
<p>Hi Ben,</p>
<p>For newbies like me, would you mind tell me how to use the OSL script in blender? I have it pasted as an internal script under World &gt; Surface. It shows three outputs, but how do they connect to World Output in the node editor?</p>
<p>Thanks,<br>Omi</p>
</blockquote>
<p>Dean (Apr 23, 2015)</p>
<blockquote>
<p>Could you post or send me a screenshot of your node setup or an example file for one of your planet renderings?</p>
<p>Many thanks!</p>
</blockquote>
<p>LiChen (Apr 07, 2017)</p>
<blockquote>
<p>Thank you very much!! The sky looks amazing!<br>I searched hours but really couldn’t find anything about how to set up this node like that sunset gif…I’ll be very appreciate it if you can post a node screenshot:D</p>
</blockquote>
<p>c4dtoa4life (Feb 07, 2019)</p>
<blockquote>
<p>How would you set this up with Arnold Render?</p>
</blockquote>
<p>sallu (Aug 22, 2019)</p>
<blockquote>
<p>Can someone please upload a blend file using this OSL shader?<br>Thanks.</p>
</blockquote>

  <p><a class="classtest-link" href="/tags/atmosphere/" rel="tag">atmosphere</a>, <a class="classtest-link" href="/tags/nishita/" rel="tag">nishita</a>, <a class="classtest-link" href="/tags/osl/" rel="tag">osl</a>, <a class="classtest-link" href="/tags/planets/" rel="tag">planets</a>, <a class="classtest-link" href="/tags/procedural/" rel="tag">procedural</a>, <a class="classtest-link" href="/tags/shader/" rel="tag">shader</a>, <a class="classtest-link" href="/tags/sky/" rel="tag">sky</a>, <a class="classtest-link" href="/tags/volumetric/" rel="tag">volumetric</a> — Oct 2, 2014</p>
  
  <br/>
  
  
  
  
    <footer>
    <p style="text-align: center;"> Ben Simonds 2023 </p>
    <ul>
        <li>
            <a href="https://www.linkedin.com/in/bensimonds/" target="_blank" style="text-decoration: none" rel="noreferrer"
                aria-label="LinkedIn">
                <svg class="icon"  width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <title>LinkedIn</title>
                    <path
                        d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
                </svg>
            </a>
        </li>
        <li>
            <a href="https://github.com/bensimonds" target="_blank" rel="noreferrer"
                aria-label="GitHub">
                <svg class="icon" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <title>GitHub</title>
                    <path
                        d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
                </svg>
            </a>
        </li>
    </ul>
<footer>

</body>
</html>
